// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EnumRole {
  ADMIN
  MANAGER
  USER
}

enum EnumStatus { 
  ACTIVE
  INVITED
  SUSPENDED
}

enum EnumStatusProject { 
  ACTIVE
  ARCHIVED
}

enum EnumPlan {
  FREE
  PRO
  ENTERPRISE
}

enum EnumStatusTask {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum EnumPriority {
  LOW 
  MEDIUM
  HIGH
  URGENT
}

model User {
  id             String   @id @default(uuid()) @db.Uuid
  email          String   @unique
  passwordHash   String   @map("password_hash")
  name           String
  avatar         String?
  isActive       Boolean  @map("is_active") @default(true)
  emailVerified  Boolean  @default(false)
  lastLoginAt    DateTime? @map("last_login_at")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  memberships         Membership[]    @relation("UserMemberships")
  invitedMemberships  Membership[]    @relation("UserInvitations")
  ownedOrgs           Organization[]  @relation("OrganizationOwner")
  projects            Project[]
  assignedTasks       Task[]          @relation("TaskAssignee")
  reportedTasks       Task[]          @relation("TaskReporter")
  comments            Comment[]
  refreshTokens       RefreshToken[]  @relation("UserRefreshTokens")
  logs                AuditLog[]
}

model Organization {
  id            String      @id @default(uuid())    @db.Uuid
  name          String
  slug          String      @unique
  plan          EnumPlan    @default(FREE)
  isActive      Boolean     @map("is_active")       @default(true)

  ownerUserId   String      @db.Uuid  @map("owner_user_id")
  owner         User        @relation("OrganizationOwner", fields: [ownerUserId], references: [id])

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  deletedAt     DateTime?   @map("deleted_at")

  memberships   Membership[]
  tasks         Task[]
  projects      Project[]    
  comments      Comment[]
  auditLogs     AuditLog[]
}



model Membership {
  id              String        @id @default(uuid()) @db.Uuid

  userId          String        @map("user_id")      @db.Uuid
  user            User          @relation("UserMemberships", fields: [userId], references: [id])

  organizationId  String        @map("organization_id") @db.Uuid
  organization    Organization  @relation(fields: [organizationId], references: [id])

  role            EnumRole      @default(USER)
  status          EnumStatus    @default(ACTIVE)

  joinedAt        DateTime      @default(now()) @map("joined_at")
  createdAt       DateTime      @default(now()) @map("created_at")

  invitedBy       String?       @map("invited_by") @db.Uuid
  invitedByUser   User?         @relation("UserInvitations", fields: [invitedBy], references: [id])

  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])

  @@map("membership")
}


model Project {
  id              String        @id @default(uuid()) @db.Uuid

  organizationId  String        @map("organization_id") @db.Uuid
  organization    Organization  @relation(fields: [organizationId], references: [id])

  name            String
  description     String?

  status          EnumStatusProject   @default(ACTIVE)
  
  createdBy       String        @map("created_by") @db.Uuid
  createdByUser   User          @relation(fields: [createdBy], references: [id])

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  tasks           Task[]

  @@index([organizationId])
  @@unique([organizationId, name])
}


model Task {
  id              String        @id @default(uuid()) @db.Uuid

  organizationId  String        @map("organization_id") @db.Uuid
  organization    Organization  @relation(fields: [organizationId], references: [id])

  projectId       String        @map("project_id")  @db.Uuid
  project         Project       @relation(fields: [projectId], references: [id])

  title           String
  description     String?
  status          EnumStatusTask @default(TODO)
  priority        EnumPriority   @default(MEDIUM)

  assigneeId      String?       @map("assignee_id") @db.Uuid
  assignee        User?         @relation("TaskAssignee", fields: [assigneeId], references: [id])

  reporterId      String        @map("reporter_id") @db.Uuid
  reporter        User          @relation("TaskReporter", fields: [reporterId], references: [id])

  dueDate         DateTime?     @map("due_date")
  completedAt     DateTime?     @map("completed_at")

  position        Int?
  idempotencyKey  String?       @map("idempotency_key")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  comments        Comment[]

  @@index([organizationId])
  @@index([projectId])
  @@index([assigneeId])
  @@index([organizationId, projectId])
  @@unique([organizationId, idempotencyKey])
}

model Comment {
  id              String        @id @default(uuid()) @db.Uuid

  organizationId  String        @map("organization_id") @db.Uuid
  organization    Organization  @relation(fields: [organizationId], references: [id])

  taskId          String        @map("task_id") @db.Uuid
  task            Task          @relation(fields: [taskId], references: [id])

  authorId        String        @map("author_id") @db.Uuid
  author          User          @relation(fields: [authorId], references: [id])

  content         String

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  @@index([taskId])
  @@index([organizationId])
}

model RefreshToken {
  id                    String   @id @default(uuid()) @db.Uuid

  userId                String   @db.Uuid @map("user_id") 
  user                  User     @relation("UserRefreshTokens", fields: [userId], references: [id])

  tokenHash             String   @map("token_hash")
  expiresAt             DateTime @map("expires_at")
  revokedAt             DateTime? @map("revoked_at")

  replacedByTokenId String? @map("replaced_by_token_id") @db.Uuid
  replacedBy RefreshToken? @relation("TokenReplacement", fields: [replacedByTokenId], references: [id])
  replaces RefreshToken[] @relation("TokenReplacement")

  createdAt             DateTime @default(now()) @map("created_at")

  @@index([userId])
}

model AuditLog {
  id              String        @id @default(uuid()) @db.Uuid

  organizationId  String        @db.Uuid @map("organization_id")  
  organization    Organization  @relation(fields: [organizationId], references: [id])

  userId          String?       @map("user_id")  @db.Uuid
  user            User?         @relation(fields: [userId], references: [id])

  action          String   // ex: TASK_CREATED
  entityType      String        @map("entity_type") // ex: TASK
  entityId        String?       @map("entity_id")

  metadata        Json?

  createdAt       DateTime      @default(now()) @map("created_at")

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([organizationId, createdAt])
}